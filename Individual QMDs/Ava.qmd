# Ava's QMD Work

###Intro and Problem Framework
#Project Goals
The primary goal of our project is to build an interpretable machine learning model that can assess whether a breast mass is benign or malignant using measurable characteristics such as radius, area, smoothness, and concavity extracted from digitized medical images. Our analysis has two complementary aims: prediction, where we train a classifier to estimate the probability that a new mass is malignant, and inference, where we identify and interpret the features that have the greatest influence on these probability assignments. Because our target audience includes clinicians, researchers, and individuals without a technical background, we emphasize transparency and interpretability, focusing not only on whether the model predicts accurately, but also on why it arrives at its predictions. The project will also address relevant challenges, including potential noise in the imaging-derived features, limitations of an older dataset, and the need for models that doctors can trust when making time-sensitive decisions.

#Importance and Relevance
Given that breast cancer is the second most common cancer among women, accounting for roughly 30% of all new female cancer cases each year, and the second leading cause of cancer-related death in women, our findings have significant implications for early detection and treatment. As incidence rates continue to rise by about 1% annually, improving methods for identifying malignant tumors early is essential. Enhancing early cancer detection directly affects patient outcomes, treatment choices, and healthcare planning. By identifying which features—such as radius, texture, or concavity—are most associated with malignant masses, we provide insights that can guide research, improve clinical understanding, and inspire better diagnostic tools using modern imaging. Furthermore, early and accurate assessment of breast masses plays a critical role in determining appropriate treatment paths, including whether surgical intervention is needed and how urgent it may be. While medical imaging technology has advanced significantly since this dataset was collected, our project provides a proof-of-concept for how interpretable machine learning techniques can support clinical decision-making. By identifying the most influential features associated with malignancy, our model can help highlight the visual and structural characteristics that matter most with insights that can not only guide preliminary diagnostic judgments but also deepen understanding of factors associated with cancerous tissue. Importantly, this work demonstrates how data-driven tools can complement, not replace, medical expertise as a doctor must understand and trust a model before using it in practice. Even with its limitations, our modeling framework remains highly relevant today and can be extended or retrained on more modern, higher-resolution imaging data to support future innovations in surgical planning, triage, and diagnostic support.




## Reading in the Data

```{r}
# Loading the packages
library(tidyverse)
library(ggplot2)
library(dplyr)
library(caret)
library(pROC)
library(glmnet)

# Loading the data
df <- read.csv("~/STA-325-Final-Project/Data/data.csv")
```

## EDA for SE

The standard error variables represent the standard error of each measurement (e.g., radius_se, texture_se, area_se). The standard error provides an estimate of how much the measurement varies within a given tumor sample. This means that each SE captures the local variability or uncertainty in the cell measurements taken from that tumor.

Since tumors that are malignant often show greater irregularity and variation in cell shape, size, and texture, it is important to analyze SE. By exploring these SE features, the EDA can highlight whether malignant tumors show consistently higher variability than benign tumors. This helps us understand how intra-tumor variability contributes to diagnosis and whether SE features may be strong predictors in distinguishing malignant from benign cases. For example, SE variables help detect instability or irregularity in tumor structure. A high SE may indicate heterogeneous cell populations, which often correspond to malignancy. 

### Table Comparing Benign vs Malignant
```{r}
# Creating summary table for all _se variables

stats_se <- df |>
group_by(diagnosis) |>
summarise(
  count = n(),
  mean_radius_se = mean(radius_se, na.rm = TRUE),
  median_radius_se = median(radius_se, na.rm = TRUE),
  se_radius = sd(radius_se, na.rm = TRUE),
  mean_texture_se = mean(texture_se, na.rm = TRUE),
  median_texture_se = median(texture_se, na.rm = TRUE),
  se_texture = sd(texture_se, na.rm = TRUE),
  mean_perimeter_se = mean(perimeter_se, na.rm = TRUE),
  median_perimeter_se = median(perimeter_se, na.rm = TRUE),
  se_perimeter = sd(perimeter_se, na.rm = TRUE),
  mean_area_se = mean(area_se, na.rm = TRUE),
  median_area_se = median(area_se, na.rm = TRUE),
  se_area = sd(area_se, na.rm = TRUE),
  mean_smoothness_se = mean(smoothness_se, na.rm = TRUE),
  median_smoothness_se = median(smoothness_se, na.rm = TRUE),
  se_smoothness = sd(smoothness_se, na.rm = TRUE),
  mean_compactness_se = mean(compactness_se, na.rm = TRUE),
  median_compactness_se = median(compactness_se, na.rm = TRUE),
  se_compactness = sd(compactness_se, na.rm = TRUE),
  mean_concavity_se = mean(concavity_se, na.rm = TRUE),
  median_concavity_se = median(concavity_se, na.rm = TRUE),
  se_concavity = sd(concavity_se, na.rm = TRUE),
  mean_concave.points_se = mean(concave.points_se, na.rm = TRUE),
  median_concave.points_se = median(concave.points_se, na.rm = TRUE),
  se_concave.points = sd(concave.points_se, na.rm = TRUE),
  mean_symmetry_se = mean(symmetry_se, na.rm = TRUE),
  median_symmetry_se = median(symmetry_se, na.rm = TRUE),
  se_symmetry = sd(symmetry_se, na.rm = TRUE),
  mean_fractal_dimension_se = mean(fractal_dimension_se, na.rm = TRUE),
  median_fractal_dimension_se = median(fractal_dimension_se, na.rm = TRUE),
  se_fractal_dimension = sd(fractal_dimension_se, na.rm = TRUE)
)

# Transposing the summary table
stats_se_t <- t(stats_se)

# Put diagnosis labels as columns
colnames(stats_se_t) <- as.character(unlist(stats_se_t[1, ]))
stats_se_t <- stats_se_t[-1, ]

```

### Observations
- Across nearly all SE features, malignant tumors show substantially higher variability than benign ones. For example, radius_se, perimeter_se, and especially area_se have standard errors that are 2–7× larger for malignant tissue. This suggests that malignant tumors tend to have much more internal inconsistency in cell shape and size.

- Area SE shows one of the strongest contrasts between groups. Malignant tumors have an average area_se more than 3× larger than benign tumors, and the SD is also dramatically higher (≈61 vs ≈9). This indicates that cell areas fluctuate far more within malignant masses, reflecting structural irregularity.

- Perimeter SE and concavity-related SEs also differ sharply. Malignant samples have perimeter and concavity SE values that are multiple times larger, implying greater irregularity along the tumor boundary. Since concavity and concave points reflect how “jagged” the edges are, the high SE suggests malignant tumors have more uneven surfaces.

- Some SE features show smaller differences in central tendency but still higher variability for malignant tissue. For example, texture_se has nearly identical means for benign and malignant tumors, yet malignant tumors have a slightly lower standard deviation. This indicates texture variation is not as strong a discriminator as geometric features like area or radius.

- Smoothness SE and fractal dimension SE show relatively small differences between malignant and benign samples. These features may be less sensitive to malignancy-driven structural variability, or they may simply have lower intrinsic variability overall. This suggests they may be weaker predictors compared to concavity- or area-related SE features.

- Concave points SE and concavity SE consistently show higher means and SDs for malignant tumors, reinforcing the known behavior that malignant masses tend to have irregular, non-smooth boundaries.

Overall pattern: SE features that reflect size (radius, area, perimeter) and shape complexity (concavity, concave points) show the strongest separation between benign and malignant tumors.



### Basic Distributions Separated by Tissue Type

```{r}
levels_diag <- levels(factor(df$diagnosis))
pal <- rev(scales::hue_pal()(length(levels_diag)))
names(pal) <- levels_diag  
```

#### Radius

```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = radius_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
  scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_radius_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_radius_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Radius (SE)", y = "Count", 
       title = "Distribution of Radius SE by Diagnosis")


```
The above graph shows the SE radius based on whether the tissue is benign or malignant. The mean values are in the dashed lines and the median values are the solid lines.

The shape of these distrubutions are not exactly similar, where malignant is right skewed and benign is normally distrubuted with a lower mean. 

We also see that the benign distribution has a mean very close to the median, whereas the malignant distribution has a mean which is greater than the median due to outliers.

Both look fairly normally distributed with a little right skew, so we may want to address the outliers in the malignant distribution.

#### Texture
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = texture_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
  scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_texture_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_texture_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Texture (SE)", y = "Count",
       title = "Distribution of Texture SE by Diagnosis")

```
These distributins have a fairly similar shape and both look roughly normal although there are some potential outliers for both benign and malignant tissue as they are both slightly right skewed. Transformation is likely not needed for this distribution unless we want to correct for outliers.

#### Perimeter
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = perimeter_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
  scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_perimeter_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_perimeter_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Perimeter (SE)", y = "Count",
  title = "Distribution of Perimeter SE by Diagnosis")


```
For Perimeter we notice that malignant tissue is more right-skewed based on the fact that the mean is a bit higher than the median. Although a transformation could be useful to correct for this asymmetry, we might not want to transform the distributions since the malignant distribution is fairly normal still. 

#### Area
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = area_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
  scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_area_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_area_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Area (SE)", y = "Count",
  title = "Distribution of Area SE by Diagnosis")

```
There is a very strong of a right skew for malignant tissue and the mean and median for benign tissue is a lot lower than malignant. May not need to transform may want to just correct for outliers in malignant tissue. 

#### Smoothness
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = smoothness_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_smoothness_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_smoothness_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Smoothness (SE)", y = "Count",
  title = "Distribution of Smoothness SE by Diagnosis")

```
This distribution is fairly similar across both tissues although benign does tend to have a higher mean and median value of smoothness.

#### Compactness
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = compactness_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_compactness_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_compactness_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Compactness (SE)", y = "Count",
  title = "Distribution of Compactness SE by Diagnosis")

```
Both malignant and benign tissue seem to be right skewed and take on a similar distribution with malignant median and mean compactness SE higher than benign tissue. 

#### Concavity
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = concavity_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_concavity_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_concavity_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Concavity (SE)", y = "Count",
  title = "Distribution of Concavity SE by Diagnosis")

```
Again, both malignant and benign are right skewed but take on a very similar distrubution, wuth malignant concavity SE mean dna median higher than benign. 


#### Convace Points
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = concave.points_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_concave.points_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_concave.points_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Concave Points (SE)", y = "Count",
  title = "Distribution of Concave Points SE by Diagnosis")
  

```
The mean concave points are both fairly normally distributed with the malignant tissue having a much higher mean an median when comparing the types of tissue which could be something to explore further. It also seems benign may be a bit more left skewed, so we may want to take a look at this outlier. 

#### Symmetry
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = symmetry_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_symmetry_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_symmetry_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Symmetry (SE)", y = "Count",
  title = "Distribution of Symmetry SE by Diagnosis")

```
Symmetry has closer median values but malignant tissue has several outliers leading to a right skew in the distribution. There seems to be one benign outlier as well. 

#### Fractal Dimension
```{r}
# Basic distributions of these variables
ggplot(df) +
  geom_histogram(aes(x = fractal_dimension_se, fill = diagnosis), alpha = 0.3) +
  theme_bw() +
  scale_fill_manual(values = pal, name = "Diagnosis") +
    scale_color_manual(values = pal, name = "Diagnosis") + 
  geom_vline(data = stats_se, aes(xintercept = mean_fractal_dimension_se, 
                                  color = diagnosis), linetype = "dashed") +
  geom_vline(data = stats_se, aes(xintercept = median_fractal_dimension_se, 
                                  color = diagnosis), linetype = "solid") +
  labs(x = "Fractal Dimension (SE)", y = "Count",
  title = "Distribution of Fractal Dimension SE by Diagnosis")

```
Both of these distributions are right skewed, but they are fairly close in terms of how they overal over each other. Transforming this feature might be a good idea to address the normality assumptions. Benign tissue seems to be more right skewed than malignant tissue, showing these outliers may need to be explored more. 



###Predictions:
Data Cleanup and CV Set up 
```{r}
#clean data
df_knn <- df |> select(-X)

# outcome must be a factor for caret + ROC
df_knn$diagnosis <- factor(df_knn$diagnosis, levels = c("B", "M"))

#train-split
set.seed(325)
train_index <- createDataPartition(df_knn$diagnosis, p = 0.8, list = FALSE)
train <- df_knn[train_index, ]
test  <- df_knn[-train_index, ]

#normalize numeric predictors bc KNN requires scaling 
preproc <- preProcess(train[, -2], method = c("center", "scale"))
train_scaled <- predict(preproc, train[, -2])
test_scaled  <- predict(preproc, test[, -2])

#attach diagnosis back
train_scaled$diagnosis <- train$diagnosis
test_scaled$diagnosis  <- test$diagnosis
```

KNN Regression with 5 fold CV
```{r}

#set up 5-fold CV
ctrl <- trainControl(
  method = "cv",
  number = 5,
  classProbs = TRUE,    
  summaryFunction = twoClassSummary,
  savePredictions = "final"
)

# Train KNN with tuning
set.seed(325)
knn_fit <- train(
  diagnosis ~ ., 
  data = train_scaled,
  method = "knn",
  trControl = ctrl,
  metric = "ROC",
  tuneLength = 20
)

#best k
knn_fit$bestTune
plot(knn_fit)


```
Chooses k = 11 as the best number of neighbors. k = 11 produced the highest average ROC across the 5 CV folds. We will use this k value for our predictions. 

Prediction on Test Set
```{r}
knn_probs <- predict(knn_fit, newdata = test, type = "prob")
head(knn_probs)

#pred class w .5 cutoff may want to change this 
pred_class <- predict(knn_fit, newdata = test)


#performance
confusionMatrix(pred_class, test$diagnosis)
roc_curve <- roc(response = test$diagnosis, predictor = knn_probs$M)
auc(roc_curve)

```
The model’s predictive performance shows that while overall accuracy is 0.628, this is no better than the No Information Rate, meaning the model is essentially performing at chance and not outperforming a naive classifier that always predicts the majority class. The very high sensitivity (0.93) indicates the model correctly identifies most benign tumors, but the extremely low specificity (0.12) shows it almost never correctly identifies malignant tumors—an undesirable outcome in a cancer-detection setting where missing malignant cases is far more harmful than over-calling benign ones. The low Kappa value (0.058) further confirms that the agreement between predictions and true labels is barely above random. The ROC AUC of 0.624 suggests poor discriminative ability, meaning the model struggles to separate benign from malignant cases. Overall, this model demonstrates significant imbalance in classification performance and is not reliable for detecting malignant cancers. This model doesn't perform very well and it would require improved features, tuning, or a different modeling approach to be clinically meaningful. Raising the cutoff will change the distribution of errors, but it will not make the model good. It’ll just make it miss more benign cases while only slightly improving detection of malignant ones.




###Interpretation 
Lasso with 5-fold CV to find important predictors

Data cleanup and preparation
```{r}
df_lasso <- df

#convert diagnosis to a binary factor
df_lasso$diagnosis_binary <- ifelse(df_lasso$diagnosis == "M", 1, 0)

#remove non-predictor columns 
predictors <- df_lasso |>
  select(-id, -diagnosis, -X) 

#separate predictors and response
x <- as.matrix(predictors |> select(-diagnosis_binary))
y <- df_lasso$diagnosis_binary
```

Run CV and Lasso
```{r}

# 5-fold CV
set.seed(325)  
cv_lasso <- cv.glmnet(x, y, 
                      alpha = 1,          # alpha = 1 for LASSO
                      family = "binomial",
                      nfolds = 5,         
                      type.measure = "class")

best_lambda <- cv_lasso$lambda.min
best_lambda

#fit model w best
lasso_model <- glmnet(x, y, alpha = 1, family = "binomial", lambda = best_lambda)

#extract coefficients as a regular matrix
coef_lasso <- as.matrix(coef(lasso_model))

#filter for non-zero coefficients
important_predictors <- coef_lasso[coef_lasso[,1] != 0, , drop = FALSE]

#important predictors
important_predictors


```
The lasso logistic regression model identifies a subset of features that are most influential in predicting whether a tumor is malignant or benign. Higher values of concave.points_mean (14.40) and concave.points_worst (16.61) strongly increase the predicted probability of malignancy, suggesting that tumors with more pronounced concave points are more likely to be malignant. Similarly, radius_se, texture_worst, smoothness_worst, concavity_worst, and symmetry_worst also have positive contributions, though smaller, indicating that variations in these measurements are associated with malignancy risk. fractal_dimension_se has a large negative coefficient (-90.18), implying that higher values strongly reduce the predicted probability of malignancy. Overall, these selected features provide an interpretable set of predictors that could be used to focus future models on the most diagnostically relevant tumor characteristics.
